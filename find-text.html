<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>.txt Locator — textbooks + laws + rules across repos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --bad:#f87171; }
  html,body{margin:0;background:#0b1220;color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;gap:.75rem;align-items:center;padding:14px 16px;background:#0d1529;border-bottom:1px solid #1f2937;position:sticky;top:0;z-index:5}
  h1{font-size:16px;margin:0 8px 0 0;font-weight:700}
  .pill{background:#1f2937;border:1px solid #374151;border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
  input[type="text"]{background:#0a1020;border:1px solid #334155;color:var(--ink);border-radius:8px;padding:8px 10px;min-width:260px}
  button{background:#1e40af;border:1px solid #1d4ed8;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  main{max-width:1100px;margin:18px auto;padding:0 16px}
  .help{color:var(--muted);margin:8px 0 16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:inline-flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px 8px;border-bottom:1px solid #1f2937;vertical-align:top}
  th{color:#cbd5e1;text-align:left;background:#0d1426;position:sticky;top:52px;z-index:2}
  .kind{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #374151;background:#0d1426;color:#d1d5db}
  .kind[data-k="Textbook"]{border-color:#2563eb;color:#bfdbfe}
  .kind[data-k="Law"]{border-color:#22c55e;color:#bbf7d0}
  .kind[data-k="Rule"]{border-color:#eab308;color:#fde68a}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)}
  .bad{color:var(--bad)}
  .warn{color:var(--warn)}
  .tiny{font-size:12px}
  details{margin:10px 0}
  .badge{font-size:12px;border:1px solid #374151;border-radius:6px;padding:2px 6px;color:#cbd5e1}
  .right{margin-left:auto}
  .token{min-width:340px}
  .note{margin-top:10px;color:#93c5fd}
</style>
</head>
<body>
<header>
  <h1>.txt Locator</h1>
  <span class="badge">textbooks + laws + rules across repos</span>
  <span class="right"></span>
  <label class="pill"><input id="showMoves" type="checkbox"> show move commands</label>
  <details class="pill"><summary>auth (optional)</summary>
    <div class="row" style="margin-top:8px">
      <input id="token" class="token" type="text" placeholder="Paste a GitHub token (public_repo or read-only) — stored only in this browser">
      <button id="saveTok">Save</button>
      <button id="clearTok" style="background:#374151;border-color:#475569">Clear</button>
    </div>
    <div class="tiny muted">Using a token avoids GitHub’s anonymous 60-requests/hour limit. Nothing is sent anywhere except to GitHub from your browser; we store it in localStorage on this device only.</div>
  </details>
</header>

<main>
  <div class="row">
    <input id="q" type="text" placeholder="Filter (e.g., lewin, birks, jersey, JTL-1984)…">
    <button id="scan">Scan now</button>
    <span id="status" class="help"></span>
  </div>

  <div class="help tiny">
    Canonical destinations:
    <ul>
      <li>Textbooks → <code>Law-Texts-ui/data/textbooks/&lt;jersey|uk&gt;/&lt;filename&gt;.txt</code></li>
      <li>Laws → <code>Law-Texts-ui/data/laws/&lt;jersey|uk&gt;/&lt;filename&gt;.txt</code></li>
      <li>Rules → <code>Law-Texts-ui/data/rules/&lt;jersey|uk&gt;/&lt;filename&gt;.txt</code></li>
    </ul>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th style="width:32%">File</th>
        <th>Kind</th>
        <th>Repo / Path</th>
        <th>Jurisdiction</th>
        <th>Size</th>
        <th>Open</th>
        <th>Canonical destination</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="msg" class="note" style="display:none"></div>
</main>

<script>
(function(){
  const user = "Info1691"; // org/user owner
  // Repos & paths we actually care about (no repo enumeration -> fewer API calls, no hang).
  const SCAN_TARGETS = [
    {repo:"Law-Texts-ui", paths:["data/textbooks/jersey","data/textbooks/uk","data/laws/jersey","data/rules/jersey","data/rules/uk"]},
    {repo:"laws-ui",      paths:["data/laws/jersey","data/laws/uk"]},
    {repo:"rules-ui",     paths:["data/rules/jersey","data/rules/uk"]},
    {repo:"lex-ingest-local", paths:["law-index/texts/jersey","law-index/texts/uk","law-index/texts"]},
    {repo:"law-index",    paths:["data/texts/jersey","data/texts/uk","data/texts"]},
  ];

  const el = sel => document.querySelector(sel);
  const status = el("#status");
  const tbl = el("#tbl");
  const tbody = tbl.querySelector("tbody");
  const msg = el("#msg");
  const q = el("#q");
  const showMoves = el("#showMoves");

  const tokInput = el("#token");
  const saveTok = el("#saveTok");
  const clearTok = el("#clearTok");
  const saved = localStorage.getItem("law_tools_token");
  if (saved) tokInput.value = saved;

  saveTok.onclick = () => {
    localStorage.setItem("law_tools_token", tokInput.value.trim());
    toast("Token saved locally.");
  };
  clearTok.onclick = () => {
    localStorage.removeItem("law_tools_token");
    tokInput.value = "";
    toast("Token cleared.");
  };

  function toast(t){ status.textContent = t; setTimeout(()=>status.textContent="",3000); }

  function toCanonical(kind, repo, path){
    // filename last segment
    const parts = path.split("/");
    const file = parts[parts.length-1];
    // try to guess jurisdiction from path
    const lower = path.toLowerCase();
    const j = lower.includes("/jersey/") ? "jersey" : lower.includes("/uk/") ? "uk" : "jersey";
    if (kind==="Textbook") return `Law-Texts-ui/data/textbooks/${j}/${file}`;
    if (kind==="Law") return `Law-Texts-ui/data/laws/${j}/${file}`;
    if (kind==="Rule") return `Law-Texts-ui/data/rules/${j}/${file}`;
    return `Law-Texts-ui/data/${j}/${file}`;
  }

  function kindFromPath(path, repo){
    const p = path.toLowerCase();
    if (p.includes("/textbook") || p.includes("underhill") || p.includes("lewin") || p.includes("principles-of-jersey-trusts") || p.includes("breach-of-trust") || p.includes("litigating-trust")) return "Textbook";
    if (p.includes("/rules/") || repo==="rules-ui") return "Rule";
    if (p.includes("/laws/") || repo==="laws-ui") return "Law";
    // lex-ingest-local / law-index buckets:
    if (p.includes("/law-index/texts/") || p.includes("/data/texts/")) return "Textbook";
    return "Textbook";
  }

  function jurFromPath(path){
    const p = path.toLowerCase();
    if (p.includes("/jersey/")) return "jersey";
    if (p.includes("/uk/")) return "uk";
    return "";
  }

  async function gh(path){
    const headers = { "Accept":"application/vnd.github+json" };
    const t = (tokInput.value || "").trim();
    if (t) headers.Authorization = `Bearer ${t}`;
    const r = await fetch(`https://api.github.com${path}`, { headers });
    if (!r.ok){
      // produce helpful errors
      let detail = "";
      try { const j = await r.json(); detail = j.message || ""; } catch {}
      const err = new Error(`GitHub API ${r.status}: ${detail || r.statusText}`);
      err.status = r.status; err.detail = detail;
      throw err;
    }
    return r.json();
  }

  async function listDir(repo, path){
    // returns array of {repo, path, size, url, html_url}
    try{
      const items = await gh(`/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`);
      if (!Array.isArray(items)) return [];
      const out = [];
      for (const it of items){
        if (it.type==="file" && it.name.toLowerCase().endsWith(".txt")){
          out.push({repo, path:`${path}/${it.name}`, size:it.size, html:it.html_url, raw:it.download_url});
        } else if (it.type==="dir"){
          // shallow recursion (one level) to keep calls low
          try{
            const sub = await gh(`/repos/${user}/${repo}/contents/${encodeURIComponent(path+"/"+it.name)}`);
            for (const s of sub){
              if (s.type==="file" && s.name.toLowerCase().endsWith(".txt")){
                out.push({repo, path:`${path}/${it.name}/${s.name}`, size:s.size, html:s.html_url, raw:s.download_url});
              }
            }
          }catch(e){ /* ignore missing subdir */ }
        }
      }
      return out;
    }catch(e){
      // handle rate limit nicely
      if (e.status===403 && (e.detail||"").toLowerCase().includes("rate limit")){
        throw new Error("GitHub API rate limit hit. Paste a token (top right) or wait a bit, then Scan again.");
      }
      // 404 paths are fine (not every repo has all paths)
      if (e.status===404) return [];
      throw e;
    }
  }

  function render(rows){
    const filter = q.value.trim().toLowerCase();
    tbody.innerHTML = "";
    let shown = 0;
    for (const r of rows){
      const text = `${r.name} ${r.repo} ${r.path} ${r.kind} ${r.jur}`.toLowerCase();
      if (filter && !text.includes(filter)) continue;
      const tr = document.createElement("tr");
      const openLinks = `<a href="${r.html}" target="_blank">GitHub</a> · <a href="${r.raw}" target="_blank">RAW</a>`;
      const move = `mv ${r.repo}/${r.path} Law-Texts-ui/${toCanonical(r.kind, r.repo, r.path)}`;
      tr.innerHTML = `
        <td><code>.txt</code> ${r.name}</td>
        <td><span class="kind" data-k="${r.kind}">${r.kind}</span></td>
        <td><div>${r.repo}<br><span class="muted tiny">${r.path}</span></div></td>
        <td>${r.jur || ""}</td>
        <td>${r.size ? (r.size<1024? r.size+" B": (r.size/1024).toFixed(0)+" KB") : ""}</td>
        <td class="tiny">${openLinks}</td>
        <td class="tiny"><code>${toCanonical(r.kind, r.repo, r.path)}</code>${showMoves.checked? `<div class="muted tiny">move: <code>${move}</code></div>`:""}</td>`;
      tbody.appendChild(tr);
      shown++;
    }
    tbl.style.display = shown? "table" : "none";
    msg.style.display = shown? "none":"block";
    msg.textContent = shown? "" : "No .txt files matched this filter.";
    status.textContent = `Found ${shown} file(s).`;
  }

  async function scan(){
    status.textContent = "Scanning known repos…";
    msg.style.display = "none";
    tbl.style.display = "none";
    tbody.innerHTML = "";
    el("#scan").disabled = true;

    const rows = [];
    try{
      for (const target of SCAN_TARGETS){
        for (const p of target.paths){
          const list = await listDir(target.repo, p);
          for (const it of list){
            const name = it.path.split("/").pop();
            rows.push({
              name, repo: target.repo, path: it.path, size: it.size,
              html: it.html, raw: it.raw,
              kind: kindFromPath(it.path, target.repo),
              jur: jurFromPath(it.path)
            });
          }
        }
      }
      rows.sort((a,b)=> a.name.localeCompare(b.name));
      render(rows);
    }catch(e){
      msg.style.display = "block";
      msg.innerHTML = `<span class="bad">Error:</span> ${e.message}`;
      status.textContent = "";
    }finally{
      el("#scan").disabled = false;
    }
  }

  el("#scan").addEventListener("click", scan);
  q.addEventListener("input", ()=> {
    // live filter without re-scan
    const trs = Array.from(tbody.querySelectorAll("tr"));
    const filter = q.value.trim().toLowerCase();
    let count = 0;
    for (const tr of trs){
      const text = tr.innerText.toLowerCase();
      const keep = !filter || text.includes(filter);
      tr.style.display = keep? "": "none";
      if (keep) count++;
    }
    status.textContent = count? `Filtered to ${count} file(s).` : "";
  });
})();
</script>
</body>
</html>
