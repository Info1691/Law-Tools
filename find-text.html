<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>.txt Locator — textbooks + laws + rules across repos</title>
<style>
  :root{--bg:#0b2239;--ink:#0b2239;--muted:#5b6b7b;--card:#fff;--line:#eef2f6;--shadow:0 1px 3px rgba(0,0,0,.08);--blue:#0d6efd;--green:#267a4a;--red:#b42318;--gold:#7a5a00;--vio:#4527a0;--teal:#046c7a}
  body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f8fb;color:var(--ink)}
  header{background:var(--bg);color:#fff;padding:14px 16px}
  header a{color:#fff;text-decoration:none;opacity:.85}
  main{max-width:1200px;margin:18px auto;padding:0 12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  input[type="text"]{padding:8px 10px;border:1px solid #d0d7de;border-radius:8px;min-width:280px;background:#fff}
  label{color:var(--muted)}
  button{font:inherit;background:var(--blue);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:#e9eef6;color:#0b2239}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:var(--shadow)}
  th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
  th{background:#f3f6fb;text-align:left;font-weight:600}
  tr:hover td{background:#fafcff}
  code{background:#f3f6fb;padding:2px 6px;border-radius:6px}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:12px;margin-right:6px;background:#eef6ff;color:#0d6efd}
  .kind{display:inline-block;padding:2px 6px;border-radius:999px;font-size:12px;margin-right:6px}
  .k-textbook{background:#e9f5ee;color:var(--green)}
  .k-law{background:#fff3d4;color:var(--gold)}
  .k-rule{background:#f0e9ff;color:var(--vio)}
  .k-ingester{background:#e8fbff;color:var(--teal)}
  .k-source{background:#fde8e8;color:var(--red)}
  .danger{background:#fde8e8;color:var(--red);padding:2px 6px;border-radius:6px}
  .small{font-size:12px}
</style>
</head>
<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div><strong>.txt Locator</strong> — textbooks + laws + rules across repos</div>
    <div><a href="./index.html">← Back to tools</a></div>
  </div>
</header>

<main>
  <div class="controls">
    <input id="filter" type="text" placeholder="Filter (e.g., lewin, birks, jersey, JTL-1984)…">
    <label><input type="checkbox" id="showCmds"> show move commands</label>
    <button id="scanBtn">Scan now</button>
    <span class="muted" id="status"></span>
  </div>

  <table id="results">
    <thead>
      <tr>
        <th>File</th>
        <th>Kind</th>
        <th>Repo / Path</th>
        <th>Jurisdiction</th>
        <th>Size</th>
        <th>Open</th>
        <th>Canonical destination</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted small" style="margin-top:12px">
    Canonical destinations:<br>
    • Textbooks → <code>Law-Texts-ui/data/textbooks/&lt;jersey|uk&gt;/&lt;filename&gt;.txt</code><br>
    • Laws → <code>Law-Texts-ui/data/laws/&lt;jersey|uk&gt;/&lt;filename&gt;.txt</code><br>
    • Rules → <code>Law-Texts-ui/data/rules/&lt;jersey|uk&gt;/&lt;filename&gt;.txt</code>
  </p>
</main>

<script>
const OWNER = 'Info1691';
const apiRoot = 'https://api.github.com';

// Base locations we’ll probe in every repo (one level deep)
const BASES = [
  {base:'data/textbooks', kind:'textbook'},
  {base:'data/laws',      kind:'law'},
  {base:'data/rules',     kind:'rule'},
  {base:'law-index/texts',kind:'ingester'},
  {base:'source',         kind:'source'} // PDFs / leftovers
];

async function ghJSON(url){
  const r = await fetch(url,{headers:{'Accept':'application/vnd.github+json'}});
  if(!r.ok) throw new Error(`${r.status} ${r.statusText} – ${url}`);
  return r.json();
}

async function listRepos(){
  // cache repo list for this session to be gentle on rate limits
  const cacheKey = 'lt-repos';
  const cached = sessionStorage.getItem(cacheKey);
  if(cached){ try{ return JSON.parse(cached); }catch{} }
  const arr = await ghJSON(`${apiRoot}/users/${OWNER}/repos?per_page=100&type=owner&sort=updated`);
  const names = arr.map(r => r.name);
  sessionStorage.setItem(cacheKey, JSON.stringify(names));
  return names;
}

function prettySize(bytes){
  if(bytes == null) return '';
  const u=['B','KB','MB','GB']; let i=0,n=bytes;
  while(n>=1024&&i<u.length-1){n/=1024;i++}
  return `${n.toFixed(n>=10||i===0?0:1)} ${u[i]}`;
}

function ghLinks(repo, path){
  const enc = path.split('/').map(encodeURIComponent).join('/');
  return {
    web:`https://github.com/${OWNER}/${repo}/blob/main/${enc}`,
    raw:`https://raw.githubusercontent.com/${OWNER}/${repo}/main/${enc}`
  };
}

function detectJur(path){
  const m = path.match(/\/(jersey|uk)(\/|$)/i);
  return m ? m[1].toLowerCase() : '';
}

function kindBadge(kind){
  const map={textbook:'k-textbook',law:'k-law',rule:'k-rule',ingester:'k-ingester',source:'k-source'};
  const cls = map[kind]||'danger';
  const label = kind.charAt(0).toUpperCase()+kind.slice(1);
  return `<span class="kind ${cls}">${label}</span>`;
}

function canonical(kind,name,jur){
  if(!jur) jur='';
  if(kind==='textbook') return `Law-Texts-ui/data/textbooks/${jur}/${name}`;
  if(kind==='law')      return `Law-Texts-ui/data/laws/${jur}/${name}`;
  if(kind==='rule')     return `Law-Texts-ui/data/rules/${jur}/${name}`;
  // default for ingester/source (textbooks unless you change policy later)
  return `Law-Texts-ui/data/textbooks/${jur}/${name}`;
}

async function listTxtIn(repo, base){
  // try base; if present, list. Then list one level deeper dirs.
  const out=[];
  async function ls(path){
    try{
      const url = `${apiRoot}/repos/${OWNER}/${repo}/contents/${encodeURIComponent(path)}?ref=main&per_page=100`;
      const items = await ghJSON(url);
      if(!Array.isArray(items)) return [];
      return items;
    }catch{ return []; }
  }
  const top = await ls(base);
  for(const it of top){
    if(it.type==='file' && /\.txt$/i.test(it.name)){
      out.push({name:it.name,size:it.size,path:`${base}/${it.name}`});
    }else if(it.type==='dir'){
      const sub = await ls(`${base}/${it.name}`);
      for(const f of sub){
        if(f.type==='file' && /\.txt$/i.test(f.name)){
          out.push({name:f.name,size:f.size,path:`${base}/${it.name}/${f.name}`});
        }
      }
    }
  }
  return out;
}

async function scan(){
  const status = document.getElementById('status');
  status.textContent = 'Enumerating repos…';
  const repos = await listRepos();

  const all=[];
  let checked = 0;
  for(const repo of repos){
    for(const b of BASES){
      status.textContent = `Scanning ${repo}/${b.base} …`;
      const files = await listTxtIn(repo,b.base);
      for(const f of files){
        const jur = detectJur(f.path);
        const dest = canonical(b.kind,f.name,jur);
        const lnks = ghLinks(repo,f.path);
        all.push({file:f.name,kind:b.kind,repo,path:f.path,jur,size:f.size,web:lnks.web,raw:lnks.raw,dest});
      }
    }
    checked++;
  }
  render(all);
  status.textContent = `Found ${all.length} .txt file(s) across ${repos.length} repos`;
}

function render(rows){
  const filter = (document.getElementById('filter').value||'').toLowerCase().trim();
  const showCmds = document.getElementById('showCmds').checked;
  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML = '';
  // stable order: Laws, Rules, Textbooks, then others; within that by name
  const kindOrder = {law:0,rule:1,textbook:2,ingester:3,source:4};
  rows.sort((a,b)=> (kindOrder[a.kind]-kindOrder[b.kind]) || a.file.localeCompare(b.file));
  for(const r of rows){
    const hay = `${r.file} ${r.repo} ${r.path} ${r.jur} ${r.kind}`.toLowerCase();
    if(filter && !hay.includes(filter)) continue;

    const tr = document.createElement('tr');

    const tdFile = document.createElement('td');
    tdFile.innerHTML = `<span class="badge">.txt</span> <strong>${r.file}</strong>`;
    tr.appendChild(tdFile);

    const tdKind = document.createElement('td');
    tdKind.innerHTML = kindBadge(r.kind);
    tr.appendChild(tdKind);

    const tdRepo = document.createElement('td');
    tdRepo.innerHTML = `<code>${r.repo}</code><div class="muted">${r.path}</div>`;
    tr.appendChild(tdRepo);

    const tdJur = document.createElement('td');
    tdJur.innerHTML = r.jur ? `<code>${r.jur}</code>` : '<span class="danger">unknown</span>';
    tr.appendChild(tdJur);

    const tdSize = document.createElement('td');
    tdSize.textContent = prettySize(r.size);
    tr.appendChild(tdSize);

    const tdOpen = document.createElement('td');
    const cmd = `git mv ${r.repo}/${r.path} ${r.dest}`;
    tdOpen.innerHTML =
      `<a href="${r.web}" target="_blank">GitHub</a> · `+
      `<a href="${r.raw}" target="_blank">RAW</a>`+
      (showCmds ? ` · <a href="#" onclick="navigator.clipboard.writeText(${JSON.stringify(cmd)});return false;">copy move cmd</a>` : '');
    tr.appendChild(tdOpen);

    const tdDest = document.createElement('td');
    tdDest.innerHTML = `<code>${r.dest}</code>`;
    tr.appendChild(tdDest);

    tbody.appendChild(tr);
  }
}

document.getElementById('scanBtn').addEventListener('click', scan);
document.getElementById('filter').addEventListener('input', ()=>scan());
document.getElementById('showCmds').addEventListener('change', ()=>scan());
window.addEventListener('load', scan);
</script>
</body>
</html>
