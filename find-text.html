<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TXT Locator — repositories scanner</title>
<style>
  :root { --fg:#0b1221; --muted:#6b7280; --ok:#0a7f47; --warn:#b45309; --bad:#b91c1c; --chip:#eef2ff; --bg:#f8fafc; --line:#e5e7eb; }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:14px 16px;z-index:5}
  h1{margin:0 0 6px 0;font-size:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input[type=text],textarea{border:1px solid var(--line);border-radius:8px;padding:9px 10px;background:#fff;min-width:240px}
  textarea{min-width:420px;min-height:72px}
  .btn{border:1px solid #1f2937;background:#111827;color:#fff;border-radius:8px;padding:9px 14px;font-weight:600;cursor:pointer}
  .btn.link{background:#fff;color:#111827}
  .btn:disabled{opacity:.4;cursor:not-allowed}
  main{padding:18px;max-width:1400px;margin:0 auto}
  .summary{display:flex;gap:16px;flex-wrap:wrap;margin:6px 0 14px 0}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line)}
  th,td{border-top:1px solid var(--line);padding:10px 10px;text-align:left;vertical-align:top}
  th{background:#f9fafb;font-size:12px;color:#374151}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
  .tag{display:inline-block;margin-right:6px;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:#fafafa;font-size:11px;color:#374151}
  .dup{background:#fff7ed}
  .r{white-space:nowrap}
  .footer{color:var(--muted);font-size:12px;margin-top:12px}
  details{background:#fff;border:1px solid var(--line);border-radius:8px}
  details>summary{cursor:pointer;padding:10px 12px;font-weight:600}
  .box{padding:10px 12px;border-top:1px solid var(--line)}
</style>
</head>
<body>
<header>
  <h1>TXT Locator — find every .txt across repos</h1>
  <div class="row" style="margin-top:8px">
    <div>
      <label>Owner / org</label><br/>
      <input id="owner" type="text" value="info1691" />
    </div>
    <div style="flex:1 1 520px;min-width:320px">
      <label>Repos to scan (comma-separated)</label><br/>
      <textarea id="repos">Law-Tools, Law-Texts-ui, lex-ingest-local</textarea>
    </div>
    <div>
      <label>Optional GitHub token (avoids rate limits; kept only in memory)</label><br/>
      <input id="token" type="text" placeholder="ghp_… (optional)"/>
    </div>
    <div>
      <label>&nbsp;</label><br/>
      <button id="scan" class="btn">Scan now</button>
      <button id="export" class="btn link" disabled>Export CSV</button>
    </div>
  </div>
  <div class="row" style="margin-top:6px">
    <div class="chip">Canonical folders: <span class="mono">data/textbooks/**, data/laws/**, data/rules/**</span> or <span class="mono">law-index/texts/**</span></div>
    <div class="chip">Duplicates highlighted</div>
  </div>
</header>

<main>
  <div id="summary" class="summary"></div>

  <table id="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th>Repo</th>
        <th>Branch</th>
        <th>Path</th>
        <th>Category</th>
        <th>Jurisdiction</th>
        <th>Canonical?</th>
        <th class="r">Links</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <details style="margin-top:14px">
    <summary>How this works / what to do next</summary>
    <div class="box">
      <ul>
        <li>Uses the GitHub <em>tree API</em> per repo (fast, 1 request per repo + 1 for default branch). With no token, you have ~60 requests/hour.</li>
        <li>Shows every <span class="mono">.txt</span>. Category is guessed from the path:
          <span class="tag">textbooks</span> if path contains <span class="mono">/textbooks/</span>,
          <span class="tag">laws</span> if <span class="mono">/laws/</span>,
          <span class="tag">rules</span> if <span class="mono">/rules/</span>, otherwise <span class="tag">unknown</span>.
        </li>
        <li><strong>Canonical</strong> = in <span class="mono">data/textbooks/**</span>, <span class="mono">data/laws/**</span>, <span class="mono">data/rules/**</span> (for Law-Texts-ui), or <span class="mono">law-index/texts/**</span> (for lex-ingest-local).</li>
        <li>Use the "Open raw" link to eyeball content quality (normalised vs PDF artefacts) before moving.</li>
        <li>Click “Export CSV” to get a move plan (repo, path, guessed category/jurisdiction, canonical flag, raw URL).</li>
      </ul>
    </div>
  </details>

  <div class="footer">Built for locating authoritative TXT before wiring catalogs & search.</div>
</main>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const ownerEl = $('#owner'), reposEl = $('#repos'), tokenEl = $('#token');
  const scanBtn = $('#scan'), exportBtn = $('#export');
  const tbody = document.querySelector('#tbl tbody');
  const summary = $('#summary');

  async function gh(url, token){
    const h = { 'Accept': 'application/vnd.github+json' };
    if (token) h['Authorization'] = 'Bearer ' + token.trim();
    const r = await fetch(url, { headers: h });
    if (!r.ok) throw new Error(r.status + ' ' + r.statusText + ' for ' + url);
    return r.json();
  }

  async function getDefaultBranch(owner, repo, token){
    const j = await gh(`https://api.github.com/repos/${owner}/${repo}`, token);
    return j.default_branch || 'main';
  }

  async function getTree(owner, repo, branch, token){
    const j = await gh(`https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`, token);
    return (j.tree || []).filter(n => n.type === 'blob');
  }

  function categorize(path){
    if (path.includes('/textbooks/')) return 'textbooks';
    if (path.includes('/laws/')) return 'laws';
    if (path.includes('/rules/')) return 'rules';
    if (path.includes('law-index/texts/')) return 'text';
    if (path.includes('/texts/')) return 'texts';
    return 'unknown';
  }

  function jurisdiction(path){
    if (path.match(/\/jersey\//i)) return 'jersey';
    if (path.match(/\/uk\//i)) return 'uk';
    return '';
  }

  function isCanonical(repo, path){
    const inData = path.startsWith('data/textbooks/') || path.startsWith('data/laws/') || path.startsWith('data/rules/');
    const inIngest = path.startsWith('law-index/texts/');
    if (repo.toLowerCase() === 'law-texts-ui') return inData;
    if (repo.toLowerCase() === 'lex-ingest-local') return inIngest || inData; // allow either
    return inData || inIngest;
  }

  function rawUrl(owner, repo, branch, path){
    return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
  }

  function uiUrl(owner, repo, branch, path){
    return `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
  }

  function csvEscape(s){ return `"${String(s).replace(/"/g,'""')}"`; }

  scanBtn.addEventListener('click', async ()=>{
    const owner = ownerEl.value.trim();
    const token = tokenEl.value.trim();
    const repos = reposEl.value.split(',').map(s => s.trim()).filter(Boolean);
    tbody.innerHTML = '';
    summary.innerHTML = '';
    exportBtn.disabled = true;
    scanBtn.disabled = true; scanBtn.textContent = 'Scanning…';

    const rows = [];
    try{
      for (const repo of repos){
        let branch;
        try{ branch = await getDefaultBranch(owner, repo, token); }
        catch(e){ addSummary(`Repo ${repo}: ${e.message}`, 'bad'); continue; }

        let tree;
        try{ tree = await getTree(owner, repo, branch, token); }
        catch(e){ addSummary(`Tree ${repo}@${branch}: ${e.message}`, 'bad'); continue; }

        const txts = tree.filter(n => n.path.toLowerCase().endsWith('.txt'));
        addSummary(`${repo}: ${txts.length} .txt`, 'ok');

        for (const n of txts){
          const cat = categorize(n.path);
          const jur = jurisdiction(n.path);
          const canon = isCanonical(repo, n.path);
          rows.push({
            repo, branch, path:n.path, cat, jur, canon,
            raw: rawUrl(owner, repo, branch, n.path),
            ui: uiUrl(owner, repo, branch, n.path),
            base: n.path.split('/').pop().toLowerCase()
          });
        }
      }

      // mark duplicates by basename
      const counts = rows.reduce((m,r)=> (m[r.base]=(m[r.base]||0)+1, m), {});
      let i=0;
      for (const r of rows){
        const tr = document.createElement('tr');
        if (counts[r.base] > 1) tr.classList.add('dup');
        tr.innerHTML = `
          <td class="r">${++i}</td>
          <td>${r.repo}</td>
          <td class="mono">${r.branch}</td>
          <td class="mono">${r.path}</td>
          <td>${tag(r.cat)}</td>
          <td>${r.jur ? tag(r.jur) : ''}</td>
          <td>${r.canon ? '<span class="ok">Yes</span>' : '<span class="warn">No</span>'}</td>
          <td class="r">
            <a class="mono" href="${r.ui}" target="_blank" rel="noreferrer">GitHub</a> ·
            <a class="mono" href="${r.raw}" target="_blank" rel="noreferrer">Open raw</a>
          </td>`;
        tbody.appendChild(tr);
      }

      addSummary(`Total .txt: ${rows.length}`, rows.length ? 'ok' : 'bad');

      exportBtn.disabled = rows.length === 0;
      exportBtn.onclick = () => {
        const headers = ['repo','branch','path','category','jurisdiction','canonical','raw_url','github_url'];
        const lines = [headers.join(',')];
        for (const r of rows){
          lines.push([r.repo,r.branch,r.path,r.cat,r.jur,r.canon?'yes':'no',r.raw,r.ui].map(csvEscape).join(','));
        }
        const blob = new Blob([lines.join('\n')], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'txt-locator.csv'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      };

    } finally {
      scanBtn.disabled = false; scanBtn.textContent = 'Scan now';
    }
  });

  function addSummary(text, level){
    const div = document.createElement('div');
    div.className = 'chip ' + (level || '');
    div.textContent = text;
    summary.appendChild(div);
  }
  function tag(txt){ return `<span class="tag">${txt}</span>`; }
})();
</script>
</body>
</html>
