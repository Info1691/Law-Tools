<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Texts Search Tool</title>
<style>
  :root{color-scheme:dark light}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1322;color:#e7edf6}
  header{display:flex;gap:.5rem;align-items:center;padding:14px 16px;border-bottom:1px solid #1e2a43;position:sticky;top:0;background:#0b1322}
  h1{font-size:16px;margin:0 8px 0 0;color:#9fb7ff}
  input[type="text"]{flex:1;min-width:160px;background:#0f1a30;border:1px solid #233153;border-radius:10px;padding:10px 12px;color:#e7edf6;outline:none}
  input[type="text"]:focus{border-color:#3d60ff;box-shadow:0 0 0 2px rgba(61,96,255,.25)}
  .btn{background:#3d60ff;border:0;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  label{font-size:13px;opacity:.85}
  .bar{display:flex;gap:10px;align-items:center;margin-left:6px}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  h2{font-size:18px;margin:22px 0 8px;color:#bcd3ff}
  .count{font-size:13px;opacity:.75;margin-left:.4rem}
  .doc{border:1px solid #1e2a43;border-radius:12px;margin:14px 0;background:#0f1a30}
  .doc header{padding:10px 12px;background:#0d172b;border-bottom:1px solid #1e2a43}
  .doc header a{color:#9fb7ff;text-decoration:none}
  .snip{padding:10px 12px;border-top:1px solid #1e2a43;white-space:pre-wrap}
  mark{background:#ffe08a;color:#161b22;border-radius:4px;padding:0 2px}
  .meta{opacity:.7;font-size:12px;margin-left:6px}
  .muted{opacity:.75}
  .warn{background:#3d1f1f;color:#ffd3d3;border:1px solid #6b2a2a;border-radius:8px;padding:6px 10px;margin:8px 12px}
</style>
</head>
<body>
<header>
  <h1>Texts Search Tool</h1>
  <input id="q" type="text" placeholder='e.g., "beddoe consent" litigation' />
  <button id="go" class="btn">Search</button>
  <div class="bar">
    <label><input id="orMode" type="checkbox"> OR mode</label>
    <label>Window: <input id="win" type="number" value="240" style="width:72px;background:#0f1a30;color:#e7edf6;border:1px solid #233153;border-radius:8px;padding:6px 8px"></label>
    <label>Snippets/doc: <input id="snips" type="number" value="6" style="width:60px;background:#0f1a30;color:#e7edf6;border:1px solid #233153;border-radius:8px;padding:6px 8px"></label>
  </div>
</header>
<main>
  <div id="note" class="muted" style="margin-bottom:8px">
    Searches TXT via catalogs on <code>texts.wwwbcb.org</code>. Relative <code>url_txt</code> are resolved against their catalog URL. Search is case-insensitive. AND by default; toggle OR to widen.
  </div>

  <div id="summary" class="muted"></div>

  <h2>Textbooks <span id="c-books" class="count"></span></h2>
  <div id="books"></div>

  <h2>Laws <span id="c-laws" class="count"></span></h2>
  <div id="laws"></div>

  <h2>Rules <span id="c-rules" class="count"></span></h2>
  <div id="rules"></div>
</main>

<script>
/* catalogs */
const CATALOGS = {
  textbooks: 'https://texts.wwwbcb.org/texts/catalog.json',
  laws:      'https://texts.wwwbcb.org/laws.json',
  rules:     'https://texts.wwwbcb.org/rules.json'
};

/* helpers */
const escapeHtml = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const norm = s => s.normalize('NFKD').toLowerCase();
function parseQuery(q){const phrases=[],terms=[];q=q.trim();if(!q)return{phrases,terms};const rx=/"([^"]+)"|(\S+)/g;let m;while((m=rx.exec(q))){if(m[1])phrases.push(norm(m[1]));else terms.push(norm(m[2]));}return{phrases,terms}}
function makeMatcher(q,orMode){const {phrases,terms}=parseQuery(q);return hayRaw=>{const hay=norm(hayRaw);const ph=phrases.map(p=>hay.indexOf(p)!==-1);const tm=terms.map(t=>hay.indexOf(t)!==-1);const all=[...ph,...tm];if(!all.length)return false;return orMode?all.some(Boolean):all.every(Boolean)}}
function makeSnippets(hayRaw,q,maxSnips,win){const hay=norm(hayRaw);const {phrases,terms}=parseQuery(q);const needles=[...phrases,...terms].filter(Boolean);const idxs=new Set();for(const n of needles){let i=hay.indexOf(n);while(i!==-1){idxs.add(i);i=hay.indexOf(n,i+1)}}const points=Array.from(idxs).sort((a,b)=>a-b).slice(0,64);const snips=[];for(const i of points){const s=Math.max(0,i-Math.floor(win/2));const e=Math.min(hayRaw.length,i+Math.floor(win/2));snips.push(hayRaw.slice(s,e));if(snips.length>=maxSnips)break;}const hi=s=>{let out=escapeHtml(s);for(const n of needles){if(!n)continue;const rx=new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'ig');out=out.replace(rx,m=>`<mark>${escapeHtml(m)}</mark>`);}return out};return snips.map(hi)}
function resolveUrl(base,rel){try{return new URL(rel,base).toString()}catch{return rel}}
function likelyBadEncoding(text){const bad=(text.match(/\uFFFD/g)||[]).length;return bad>50 || bad>0 && bad/text.length>0.002}

/* renderers */
function renderGroup(targetElem, items){
  if(!items.length){targetElem.innerHTML='<div class="muted">No matches in this category.</div>';return}
  const frag=document.createDocumentFragment();
  for(const r of items){
    const box=document.createElement('div');
    box.className='doc';
    const warn= r.flags?.bad ? `<div class="warn">This TXT looks un-normalized (encoding artifacts detected). Consider re-ingesting or running the normalizer.</div>` : '';
    box.innerHTML=`
      <header>
        <a href="${r.href}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a>
        <span class="meta">• ${escapeHtml(r.kind)}</span>
      </header>
      ${warn}
      ${r.snippets.map(s=>`<div class="snip">${s}</div>`).join('')}
    `;
    frag.appendChild(box);
  }
  targetElem.innerHTML=''; targetElem.appendChild(frag);
}

/* main */
async function runSearch(){
  const q=document.getElementById('q').value;
  const win=Math.max(80,+document.getElementById('win').value||240);
  const snMax=Math.max(1,+document.getElementById('snips').value||6);
  const orMode=document.getElementById('orMode').checked;
  document.getElementById('summary').textContent='Loading catalogs…';

  // load catalogs
  const entries=[];
  for(const [kind,url] of Object.entries(CATALOGS)){
    try{
      const res=await fetch(url,{cache:'no-store'});
      const json=await res.json();
      const arr=Array.isArray(json)?json:(json.items||json.textbooks||[]);
      for(const it of arr){
        if(!it.url_txt) continue;
        entries.push({kind,catalogUrl:url,title:it.title||it.name||it.url_txt,url_txt:it.url_txt});
      }
    }catch(e){ console.warn('Catalog load failed:',kind,url,e); }
  }
  if(!entries.length){ document.getElementById('summary').textContent='No catalogs or entries loaded.'; return; }

  const matcher=makeMatcher(q,orMode);
  const groups={textbooks:[],laws:[],rules:[]};
  let checked=0, matched=0;

  // sequential fetch to stay within rate limits
  for(const e of entries){
    const txtUrl=resolveUrl(e.catalogUrl,e.url_txt);
    try{
      const res=await fetch(txtUrl,{cache:'no-store'}); if(!res.ok) continue;
      const text=await res.text(); checked++;
      if(!text) continue;
      if(matcher(text)){
        matched++;
        const item={
          ...e,
          href:txtUrl,
          snippets:makeSnippets(text,q,snMax,win),
          flags:{bad:likelyBadEncoding(text)}
        };
        groups[e.kind].push(item);
      }
    }catch{ /* ignore individual fetch errors */ }
  }

  document.getElementById('summary').textContent=`Checked ${checked} document(s). Matches — Textbooks: ${groups.textbooks.length} • Laws: ${groups.laws.length} • Rules: ${groups.rules.length}`;

  document.getElementById('c-books').textContent=`(${groups.textbooks.length})`;
  document.getElementById('c-laws').textContent =`(${groups.laws.length})`;
  document.getElementById('c-rules').textContent=`(${groups.rules.length})`;

  renderGroup(document.getElementById('books'), groups.textbooks);
  renderGroup(document.getElementById('laws'),  groups.laws);
  renderGroup(document.getElementById('rules'), groups.rules);
}

/* wire up */
document.getElementById('go').addEventListener('click', runSearch);
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch() });
const params=new URLSearchParams(location.search);
if(params.get('q')){ document.getElementById('q').value=params.get('q'); if(params.get('or')==='1')document.getElementById('orMode').checked=true; runSearch(); }
</script>
</body>
</html>
