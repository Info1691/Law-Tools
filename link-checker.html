<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Law Index — Link Checker</title>
  <link rel="icon" href="./logo.png" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --ok:#16a34a; --err:#ef4444; --ink:#e5e7eb; --brand:#0ea5e9;
      --row:#0b132e; --row2:#0d1b2a;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    header{display:flex;gap:.75rem;align-items:center;padding:14px 16px;background:#0b1220;border-bottom:1px solid #0f2038;position:sticky;top:0}
    header img{height:24px;width:24px;border-radius:4px;background:#fff}
    header h1{margin:0;font-size:16px;font-weight:600}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:10px;padding:16px}
    .inputs{display:grid;grid-template-columns:1fr;gap:8px;margin:8px 0 12px}
    .inputs input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #263243;background:#0b1320;color:var(--ink)}
    .actions{display:flex;gap:10px;align-items:center}
    button{background:var(--brand);color:#00131e;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    small{color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #1f2937;vertical-align:top}
    th{position:sticky;top:64px;background:#0b1220;border-bottom:1px solid #1f2937;z-index:1}
    tr:nth-child(even){background:rgba(255,255,255,0.01)}
    .pill{display:inline-block;font-size:12px;border-radius:999px;padding:2px 8px;border:1px solid #273247;color:#93c5fd;background:#0b1a2d}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
<header>
  <img src="./logo.png" alt="">
  <h1>Law Index — Link Checker</h1>
</header>
<main>
  <div class="card">
    <p>Checks every <span class="mono">url_txt</span> in the catalogs and issues a small ranged request (≈1KB) to avoid full downloads. You can override catalogs below.</p>
    <div class="inputs">
      <input id="uTextbooks" placeholder="Textbooks catalog URL"
             value="https://texts.wwwbcb.org/texts/catalog.json">
      <input id="uLaws" placeholder="Laws catalog URL"
             value="https://texts.wwwbcb.org/laws.json">
      <input id="uRules" placeholder="Rules catalog URL"
             value="https://texts.wwwbcb.org/rules.json">
    </div>
    <div class="actions">
      <button id="run">Run checks</button>
      <small id="summary">Ready.</small>
    </div>
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:120px">Source</th>
          <th>Title</th>
          <th>URL</th>
          <th style="width:70px">HTTP</th>
          <th style="width:80px">Time</th>
          <th style="width:80px">Size</th>
          <th style="width:90px">Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
const $ = sel => document.querySelector(sel);
const tbody = $('#tbl tbody');
const summary = $('#summary');

function resolveUrl(urlTxt, catalogUrl){
  // Resolve relative against the catalog’s own URL
  return new URL(urlTxt, catalogUrl).href;
}

async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(`Fetch ${url} → ${r.status}`);
  return await r.json();
}

function row(vals){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${vals.source}</td>
    <td>${vals.title || ''}</td>
    <td class="mono"><a href="${vals.url}" target="_blank" rel="noopener">${vals.url.replace(/^https?:\/\//,'')}</a></td>
    <td class="mono">${vals.http ?? ''}</td>
    <td class="mono">${vals.time ?? ''} ms</td>
    <td class="mono">${vals.size ?? ''}</td>
    <td>${vals.ok ? `<span class="ok">OK</span>` : `<span class="err">Not found</span>`}</td>
  `;
  tbody.appendChild(tr);
}

async function head(url){
  const t0 = performance.now();
  // Use a tiny ranged GET — many hosts don’t allow HEAD + Range reliably
  const r = await fetch(url, {headers:{'Range':'bytes=0-1023'}});
  const t = Math.round(performance.now() - t0);
  const size = r.headers.get('content-length') || '';
  return { ok:r.ok, status:r.status, time:t, size };
}

async function checkCatalog(label, catalogUrl){
  const list = await fetchJSON(catalogUrl);
  for(const item of list){
    const full = resolveUrl(item.url_txt, catalogUrl);
    try{
      const h = await head(full);
      row({ source:label, title:item.title, url:full, http:h.status, time:h.time, size:h.size, ok:h.ok });
    }catch(e){
      row({ source:label, title:item.title, url:full, http:'—', time:'—', size:'—', ok:false });
    }
  }
}

$('#run').addEventListener('click', async ()=>{
  tbody.innerHTML = '';
  summary.textContent = 'Running…';
  const urls = [ ['Textbooks', $('#uTextbooks').value.trim()],
                 ['Laws',      $('#uLaws').value.trim()],
                 ['Rules',     $('#uRules').value.trim()] ];
  let ok=0, bad=0;
  for(const [label, url] of urls){
    try{
      await checkCatalog(label, url);
    }catch(e){
      row({source:label, title:'(catalog fetch failed)', url:url, ok:false});
    }
  }
  // Tally
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.querySelector('.ok')) ok++; else bad++;
  });
  summary.textContent = `Done — OK: ${ok} · Errors: ${bad}`;
});
</script>
</body>
</html>
