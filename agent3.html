<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agent 3 — Semantic-ready BM25 search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="brand.css" rel="stylesheet" />
  <style>
    body { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .bar { display:flex; gap:8px; align-items:center; }
    input[type=text]{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid #333; background:#0d1117; color:#eee; }
    button{ padding:10px 14px; border-radius:8px; border:1px solid #333; background:#1f6feb; color:white; }
    .meta{ opacity:.7; font-size:.9rem; }
    .hit{ background:#0f1724; border:1px solid #223; border-radius:12px; padding:14px; margin:14px 0; }
    .title{ font-weight:600; }
    mark{ background: #444; padding:0 .15rem; border-radius:3px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    details { background:#0a0f17; border:1px dashed #2a2f3a; border-radius:10px; padding:8px 10px; }
    summary { cursor:pointer; font-weight:600; }
    .diag{ opacity:.6; font-size:.85rem; margin-top:10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
</head>
<body>
  <h1>Agent 3 — Trust Law (BM25 index)</h1>
  <div class="bar">
    <input id="q" type="text" placeholder='e.g., "beddoe consent litigation" or Saunders v Vautier' />
    <label class="meta"><input id="or" type="checkbox"> OR mode</label>
    <button id="go">Search</button>
  </div>

  <p class="meta">Searches <em>all</em> TXT listed in the catalogs on <code>texts.wwwbcb.org</code>. Results are chunk-level BM25 matches with source links. No model inference; no hallucinations.</p>

  <div id="out"></div>
  <details class="diag"><summary>Diagnostics</summary><pre id="diag"></pre></details>

<script>
// locations produced by CI
const BASE = 'https://texts.wwwbcb.org/data/agent3/';
const IDX_URL = BASE + 'lunr-index.json';
const CHUNK_URL = BASE + 'chunks.jsonl';

let idx = null;
let chunks = new Map(); // id -> chunk

async function loadAll() {
  const [idxRes, chRes] = await Promise.all([fetch(IDX_URL), fetch(CHUNK_URL)]);
  if (!idxRes.ok || !chRes.ok) { throw new Error('Index files not found. Run the agent3-bm25 workflow.'); }
  idx = lunr.Index.load(await idxRes.json());

  const dec = new TextDecoder();
  const reader = chRes.body.getReader();
  let buf = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) { if (buf.trim()) chunks.set(JSON.parse(buf).id, JSON.parse(buf)); break; }
    buf += dec.decode(value, { stream: true });
    let lines = buf.split('\n');
    buf = lines.pop();
    for (const line of lines) if (line) chunks.set(JSON.parse(line).id, JSON.parse(line));
  }
}

function doSearch(query, orMode=false) {
  if (!query || !query.trim()) return [];
  let q = query.trim();

  // quotation handling for phrases
  const terms = [];
  const phraseRe = /"([^"]+)"/g;
  let m;
  while ((m = phraseRe.exec(q))) terms.push({ type:'phrase', v:m[1] });
  q = q.replace(phraseRe, ' ').trim();
  for (const t of q.split(/\s+/).filter(Boolean)) terms.push({ type:'term', v:t });

  const clauses = terms.map(t => {
    if (t.type === 'phrase') return `${t.v}`;
    return t.v;
  });

  const final = clauses.map(c => `+${c}`).join(' ');
  const orQ = clauses.join(' ');

  const results = idx.search(orMode ? orQ : final);
  return results.map(r => {
    const c = chunks.get(r.ref);
    return { score: r.score, ...c };
  });
}

function htmlEscape(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

function highlight(snippet, terms){
  let s = snippet;
  for (const t of terms.sort((a,b)=>b.length-a.length)) {
    const re = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'ig');
    s = s.replace(re,'<mark>$1</mark>');
  }
  return s;
}

function render(hits, query){
  const out = document.getElementById('out');
  out.innerHTML = '';
  const terms = Array.from(new Set(query.toLowerCase().match(/"[^"]+"|\S+/g)||[])).map(x=>x.replace(/^"|"$/g,''));

  if (!hits.length) {
    out.innerHTML = `<p class="meta">No matches in the catalogs.</p>`;
    return;
  }

  for (const h of hits.slice(0,50)) {
    const snip = htmlEscape(h.text.slice(0, 550)).replace(/\n/g,' ');
    const url = h.url;
    const block = document.createElement('div');
    block.className = 'hit';
    block.innerHTML = `
      <div class="title">${htmlEscape(h.title)} <span class="meta">(${h.kind}; ${h.juris || '—'})</span></div>
      <div class="meta"><a href="${url}" target="_blank" rel="noopener">open TXT</a></div>
      <div style="margin-top:8px">${highlight(snip, terms)}</div>
    `;
    out.appendChild(block);
  }
}

(async () => {
  const diag = document.getElementById('diag');
  diag.textContent = `Loading index from ${IDX_URL}\nChunks: ${CHUNK_URL}`;
  await loadAll();
  diag.textContent += `\nLoaded ${chunks.size} chunks. Ready.`;

  const q = document.getElementById('q');
  const go = document.getElementById('go');
  const or = document.getElementById('or');
  const run = () => {
    const hits = doSearch(q.value, or.checked);
    render(hits, q.value);
  };
  go.onclick = run;
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });
})();
</script>
</body>
</html>
